name: Deploy to Heroku (Include code to set stack once)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  HEROKU_APP_NAME: ${{ secrets.HEROKU_APP_NAME }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Fail early if secrets are missing
      - name: Validate required secrets
        run: |
          test -n "${{ secrets.HEROKU_API_KEY }}" || (echo "HEROKU_API_KEY is empty/missing" && exit 1)
          test -n "${{ secrets.HEROKU_APP_NAME }}" || (echo "HEROKU_APP_NAME is empty/missing" && exit 1)
          echo "Secrets present."

      # Install Heroku CLI (no marketplace action needed)
      - name: Install Heroku CLI
        run: |
          curl https://cli-assets.heroku.com/install-ubuntu.sh | sh
          heroku --version

      # Ensure the app is on the 'container' stack (safe to run every time)
      - name: Ensure container stack
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          set -euo pipefail
          CURRENT=$(heroku stack -a ${{ env.HEROKU_APP_NAME }} | grep '^\*' | awk '{print $2}')
          echo "Current stack: $CURRENT"
          if [ "$CURRENT" != "container" ]; then
            echo "Switching stack to container..."
            heroku stack:set container -a ${{ env.HEROKU_APP_NAME }}
          else
            echo "Stack already 'container'."
          fi

      # Log in to Heroku container registry
      - name: Registry login
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          echo "${HEROKU_API_KEY}" | docker login --username=_ --password-stdin registry.heroku.com

      # Build, tag for Heroku registry
      - name: Build image
        run: docker build -t registry.heroku.com/${{ env.HEROKU_APP_NAME }}/web .

      # Push to Heroku registry
      - name: Push image
        run: docker push registry.heroku.com/${{ env.HEROKU_APP_NAME }}/web

      # Release the pushed image
      - name: Release
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: heroku container:release web -a ${{ env.HEROKU_APP_NAME }}
